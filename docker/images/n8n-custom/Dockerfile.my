ARG NODE_VERSION=20

# 1. Create an image to build n8n
FROM --platform=linux/amd64 n8nio/base:${NODE_VERSION} AS builder

# Build the application from source
WORKDIR /src
COPY . /src
RUN --mount=type=cache,id=pnpm-store,target=/root/.local/share/pnpm/store --mount=type=cache,id=pnpm-metadata,target=/root/.cache/pnpm/metadata DOCKER_BUILD=true pnpm install --frozen-lockfile
RUN pnpm build

# Delete all dev dependencies
RUN jq 'del(.pnpm.patchedDependencies)' package.json > package.json.tmp; mv package.json.tmp package.json
RUN node .github/scripts/trim-fe-packageJson.js

# Delete any source code, source-mapping, or typings
RUN find . -type f -name "*.ts" -o -name "*.js.map" -o -name "*.vue" -o -name "tsconfig.json" -o -name "*.tsbuildinfo" | xargs rm -rf

# Deploy the `n8n` package into /compiled
RUN mkdir /compiled
RUN NODE_ENV=production DOCKER_BUILD=true pnpm --filter=n8n --prod --no-optional deploy /compiled

# 2. Start with a new clean image with just the code that is needed to run n8n
FROM n8nio/base:${NODE_VERSION}
ENV NODE_ENV=production

ARG N8N_RELEASE_TYPE=dev
ENV N8N_RELEASE_TYPE=${N8N_RELEASE_TYPE}

WORKDIR /home/node
COPY --from=builder /compiled /usr/local/lib/node_modules/n8n
COPY docker/images/n8n/docker-entrypoint.sh /

# Setup the Task Runner Launcher
ARG TARGETPLATFORM
ARG LAUNCHER_VERSION=1.1.0
COPY docker/images/n8n/n8n-task-runners.json /etc/n8n-task-runners.json
# Download, verify, then extract the launcher binary
RUN \
	if [[ "$TARGETPLATFORM" = "linux/amd64" ]]; then export ARCH_NAME="amd64"; \
	elif [[ "$TARGETPLATFORM" = "linux/arm64" ]]; then export ARCH_NAME="arm64"; fi; \
	mkdir /launcher-temp && \
	cd /launcher-temp && \
	wget https://github.com/n8n-io/task-runner-launcher/releases/download/${LAUNCHER_VERSION}/task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz && \
	wget https://github.com/n8n-io/task-runner-launcher/releases/download/${LAUNCHER_VERSION}/task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz.sha256 && \
	# The .sha256 does not contain the filename --> Form the correct checksum file
	echo "$(cat task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz.sha256) task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz" > checksum.sha256 && \
	sha256sum -c checksum.sha256 && \
	tar xvf task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz --directory=/usr/local/bin && \
	cd - && \
	rm -r /launcher-temp

RUN \
	cd /usr/local/lib/node_modules/n8n && \
	npm rebuild sqlite3 && \
	cd - && \
	ln -s /usr/local/lib/node_modules/n8n/bin/n8n /usr/local/bin/n8n && \
	mkdir .n8n && \
	chown node:node .n8n

RUN apk --no-cache add sed
RUN sed -i -E -z 's|X509Certificate\(`([^`]+)`\)|X509Certificate\(`-----BEGIN CERTIFICATE-----\nMIIDtTCCAp0CFDy6uD07eX2/rK4FVKjBZcZMUvawMA0GCSqGSIb3DQEBCwUAMIGW\nMQswCQYDVQQGEwJWTjEPMA0GA1UECAwGSGEgTm9pMQ8wDQYDVQQHDAZIYSBOb2kx\nITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDEQMA4GA1UECwwHc2Vj\ndGlvbjEPMA0GA1UEAwwGTWVnYVZOMR8wHQYJKoZIhvcNAQkBFhBhZG1pbkBtZWdh\ndm4ubmV0MB4XDTI0MDEyNjAzNTAzN1oXDTI1MDEyNTAzNTAzN1owgZYxCzAJBgNV\nBAYTAlZOMQ8wDQYDVQQIDAZIYSBOb2kxDzANBgNVBAcMBkhhIE5vaTEhMB8GA1UE\nCgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMRAwDgYDVQQLDAdzZWN0aW9uMQ8w\nDQYDVQQDDAZNZWdhVk4xHzAdBgkqhkiG9w0BCQEWEGFkbWluQG1lZ2F2bi5uZXQw\nggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCq7+ofmFy9fOHs/lzI+I/o\n4rm26BbLkUQNEMSL+YZUk5QO+kuZ+O4+UuwEZBlms709V81Bb5U9YrwZjegl3lMe\n2DtjTA86CL5eCXEB2gJ9TsNJz3GODgmyIkWbm1+A+Ue3/00+8SRvk1tmVk2Gecfm\n+jXrS8xYH8Xa2H1Pw20ScgN0aZSSx2rxm62x4yMON+waZxpnmOg4y0ueDU1++Qbk\nW/4B9l58joC8Kq6m323G+Z0Nq0WbTEgbXpwR09xeLTg75oWfc0cRkUzC3BEM5LWG\naEVQddt/HEFVedQyENFSPOJ7GjXD3H0jauh712yJmBVMRwn+wgW7Heczx6KoD7np\nAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAFidJy/TYsuKGLNPsrp6AJTfSRg+oeLX\n4qD8WgvU2Ok/NzIYG0dkHkWB+Pnr/KZijOA5GzAE1RtBqi6ah6GhFWlDpCQ+3WOg\nHUQWwdqgzzEQSPZgzMliM0ReARMvoPzcR2L5hvdvS6BSuiitAknk9+rTQAieu3My\nOqep1P7VXX5k7LkFb/3g80w95kwV/o/GD7XRGMTSHvbcSjl6nWT/6WlcKxtSbS91\nIX2qTAQjMVepCxxsnSc+Q6GTHgRdoAkMmRvnHwCQ4VN3cel5dGqOrdElujQPFw99\nnZkk8rHkp+hKMasMibTOL3JD/As0KBLlDbDlO3MpQUype3mBxQCiEHY=\n-----END CERTIFICATE-----`\)|g' /usr/local/lib/node_modules/n8n/node_modules/@n8n_io/license-sdk/dist/LicenseManager.js /usr/local/lib/node_modules/n8n/node_modules/@n8n_io/license-sdk/dist/LicenseManager.mjs

ENV SHELL /bin/sh
USER node
ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]
